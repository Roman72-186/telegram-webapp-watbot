<!-- index.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />

  <!-- Telegram Meta Tags -->
  <meta name="telegram-web-app" content="true" />
  <meta name="theme-color" content="#3390ec" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />

  <title>Регистрация в сервисе</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- IMask -->
  <script src="https://cdn.jsdelivr.net/npm/imask@7.1.3/dist/imask.min.js"></script>

  <style>
    :root{
      --tg-theme-bg-color:#ffffff;
      --tg-theme-text-color:#000000;
      --tg-theme-hint-color:#999999;
      --tg-theme-link-color:#3390ec;
      --tg-theme-button-color:#3390ec;
      --tg-theme-button-text-color:#ffffff;
      --tg-theme-secondary-bg-color:#f1f1f1;
    }
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
      background:var(--tg-theme-bg-color);
      color:var(--tg-theme-text-color);
    }
    .tg-button{
      background:var(--tg-theme-button-color);
      color:var(--tg-theme-button-text-color);
      cursor:pointer;
      pointer-events:auto;
    }
    .tg-button:hover{ opacity:.9; }
    .tg-button:disabled{
      opacity:.5;
      cursor:not-allowed;
    }
    .tg-input{
      border:1px solid #e0e0e0;
      transition:all .2s;
    }
    .tg-input:focus{
      border-color:var(--tg-theme-button-color);
      outline:none;
      box-shadow:0 0 0 3px rgba(51,144,236,.1);
    }
    .tg-input.error{ border-color:#ff3333; }
    .error-message{
      color:#ff3333;
      font-size:.875rem;
      margin-top:.25rem;
      min-height:1.1em;
    }
    .success-message{ display:none; }
    .success-message.show{ display:block; }
    html{ scroll-behavior:smooth; }
    .checkbox-wrapper{
      position:relative;
      display:flex;
      align-items:flex-start;
      gap:.75rem;
    }
    .checkbox-wrapper input[type="checkbox"]{
      width:1.25rem;
      height:1.25rem;
      margin-top:.125rem;
      cursor:pointer;
      accent-color:var(--tg-theme-button-color);
    }
    .checkbox-wrapper label{ cursor:pointer; line-height:1.5; }
    .checkbox-wrapper a{
      color:var(--tg-theme-link-color);
      text-decoration:underline;
    }
    .checkbox-wrapper a:hover{ opacity:.8; }

    /* Ошибка отправки */
    .fatal-box{
      display:none;
      border:1px solid #ff3333;
      background:#fff5f5;
      border-radius:12px;
      padding:12px 14px;
      margin-top:14px;
      color:#b30000;
      font-size:.95rem;
    }
    .fatal-box.show{ display:block; }
  </style>
</head>

<body class="min-h-screen flex flex-col">
  <!-- Header -->
  <header class="bg-white shadow-sm py-6 px-4">
    <div class="max-w-2xl mx-auto">
      <h1 class="text-3xl font-bold text-gray-900 text-center mb-2">Добро пожаловать!</h1>
      <p class="text-gray-600 text-center">Заполните форму регистрации для доступа к нашему сервису</p>
    </div>
  </header>

  <!-- Main -->
  <main class="flex-1 max-w-2xl mx-auto w-full px-4 py-8">
    <!-- Form -->
    <div id="registrationForm" class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
      <form id="form" class="space-y-6" novalidate>
        <!-- First Name -->
        <div>
          <label for="firstName" class="block text-sm font-medium text-gray-700 mb-2">
            Имя <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            id="firstName"
            name="firstName"
            class="tg-input w-full px-4 py-3 rounded-lg text-gray-900 placeholder-gray-400"
            placeholder="Введите ваше имя"
            autocomplete="given-name"
          />
          <div id="firstNameError" class="error-message"></div>
        </div>

        <!-- Last Name -->
        <div>
          <label for="lastName" class="block text-sm font-medium text-gray-700 mb-2">
            Фамилия <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            id="lastName"
            name="lastName"
            class="tg-input w-full px-4 py-3 rounded-lg text-gray-900 placeholder-gray-400"
            placeholder="Введите вашу фамилию"
            autocomplete="family-name"
          />
          <div id="lastNameError" class="error-message"></div>
        </div>

        <!-- Phone -->
        <div>
          <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">
            Номер телефона <span class="text-red-500">*</span>
          </label>
          <input
            type="tel"
            id="phone"
            name="phone"
            class="tg-input w-full px-4 py-3 rounded-lg text-gray-900 placeholder-gray-400"
            placeholder="+7 (999) 999-99-99"
            autocomplete="tel"
            inputmode="tel"
          />
          <div id="phoneError" class="error-message"></div>
        </div>

        <!-- Checkboxes -->
        <div class="space-y-4 pt-2">
          <div class="checkbox-wrapper">
            <input type="checkbox" id="agreement1" name="agreement1" class="flex-shrink-0" />
            <label for="agreement1" class="text-sm text-gray-700">
              Я согласен с <a href="#offer">Офертой</a>
            </label>
          </div>
          <div id="agreement1Error" class="error-message ml-7"></div>

          <div class="checkbox-wrapper">
            <input type="checkbox" id="agreement2" name="agreement2" class="flex-shrink-0" />
            <label for="agreement2" class="text-sm text-gray-700">
              Я согласен с <a href="#privacy">Политикой конфиденциальности</a>
            </label>
          </div>
          <div id="agreement2Error" class="error-message ml-7"></div>

          <div class="checkbox-wrapper">
            <input type="checkbox" id="agreement3" name="agreement3" class="flex-shrink-0" />
            <label for="agreement3" class="text-sm text-gray-700">
              Я согласен с <a href="#data-processing">Обработкой персональных данных</a>
            </label>
          </div>
          <div id="agreement3Error" class="error-message ml-7"></div>
        </div>

        <!-- Submit -->
        <button
          type="submit"
          id="submitBtn"
          class="tg-button w-full py-4 px-6 rounded-lg font-semibold text-lg transition-all duration-200 shadow-md hover:shadow-lg"
        >
          Отправить
        </button>

        <!-- Loading -->
        <div id="loadingIndicator" class="hidden text-center py-4">
          <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
          <p class="mt-2 text-gray-600">Отправка данных...</p>
        </div>

        <!-- Fatal -->
        <div id="fatalBox" class="fatal-box"></div>
      </form>
    </div>

    <!-- Success -->
    <div id="successMessage" class="success-message bg-green-50 border border-green-200 rounded-2xl p-8 text-center mt-6">
      <div class="text-green-600 text-5xl mb-4">✓</div>
      <h2 class="text-2xl font-bold text-gray-900 mb-2">Спасибо!</h2>
      <p class="text-gray-700 text-lg">Ваше согласие и данные успешно получены</p>
    </div>
  </main>

  <!-- Footer -->
  <footer id="footer" class="bg-gray-50 border-t border-gray-200 mt-auto">
    <div class="max-w-4xl mx-auto px-4 py-12">
      <div class="grid md:grid-cols-3 gap-8">
        <div id="offer" class="scroll-mt-20">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Оферта</h3>
          <div class="text-sm text-gray-600 space-y-2">
            <p>Настоящая публичная оферта (далее — «Оферта») определяет условия использования сервиса.</p>
            <p>Используя наш сервис, вы соглашаетесь с условиями данной оферты.</p>
            <p>Мы оставляем за собой право изменять условия оферты в любое время без предварительного уведомления.</p>
            <p>Все изменения вступают в силу с момента публикации на данной странице.</p>
            <p>При возникновении споров стороны обязуются решать их путем переговоров.</p>
          </div>
        </div>

        <div id="privacy" class="scroll-mt-20">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Политика конфиденциальности</h3>
          <div class="text-sm text-gray-600 space-y-2">
            <p>Мы обязуемся защищать вашу конфиденциальность и персональные данные.</p>
            <p>Мы собираем только ту информацию, которая необходима для предоставления наших услуг.</p>
            <p>Ваши данные не передаются третьим лицам без вашего согласия, за исключением случаев, предусмотренных законодательством.</p>
            <p>Мы используем современные технологии для защиты ваших данных от несанкционированного доступа.</p>
            <p>Вы имеете право запросить информацию о ваших персональных данных и потребовать их удаления.</p>
          </div>
        </div>

        <div id="data-processing" class="scroll-mt-20">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Обработка персональных данных</h3>
          <div class="text-sm text-gray-600 space-y-2">
            <p>Обработка персональных данных осуществляется в соответствии с законодательством РФ.</p>
            <p>Цель обработки: предоставление услуг сервиса, улучшение качества обслуживания.</p>
            <p>Мы обрабатываем следующие данные: имя, фамилия, номер телефона.</p>
            <p>Срок хранения данных: до момента отзыва согласия на обработку.</p>
            <p>Вы можете отозвать согласие на обработку данных в любое время, отправив запрос на наш email.</p>
          </div>
        </div>
      </div>

      <div class="mt-8 pt-8 border-t border-gray-200 text-center text-sm text-gray-500">
        <p>&copy; 2025 Все права защищены</p>
      </div>
    </div>
  </footer>

  <script>
    // ===== DOM =====
    const form = document.getElementById('form');
    const registrationForm = document.getElementById('registrationForm');
    const successMessage = document.getElementById('successMessage');
    const submitBtn = document.getElementById('submitBtn');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const fatalBox = document.getElementById('fatalBox');

    const firstNameInput = document.getElementById('firstName');
    const lastNameInput  = document.getElementById('lastName');
    const phoneInput     = document.getElementById('phone');

    const agreement1 = document.getElementById('agreement1');
    const agreement2 = document.getElementById('agreement2');
    const agreement3 = document.getElementById('agreement3');

    const firstNameError = document.getElementById('firstNameError');
    const lastNameError  = document.getElementById('lastNameError');
    const phoneError     = document.getElementById('phoneError');

    const agreement1Error = document.getElementById('agreement1Error');
    const agreement2Error = document.getElementById('agreement2Error');
    const agreement3Error = document.getElementById('agreement3Error');

    // ===== Phone mask =====
    const phoneMask = IMask(phoneInput, {
      mask: '+{7} (000) 000-00-00',
      lazy: false
    });

    // ===== Helpers =====
    function showFatal(message) {
      fatalBox.textContent = message || 'Ошибка';
      fatalBox.classList.add('show');
    }
    function hideFatal() {
      fatalBox.textContent = '';
      fatalBox.classList.remove('show');
    }

    function showError(input, errorEl, message) {
      input.classList.add('error');
      errorEl.textContent = message || '';
    }
    function hideError(input, errorEl) {
      input.classList.remove('error');
      errorEl.textContent = '';
    }

    function validateFirstName() {
      const v = (firstNameInput.value || '').trim();
      if (!v) { showError(firstNameInput, firstNameError, 'Поле "Имя" обязательно для заполнения'); return false; }
      if (v.length < 2) { showError(firstNameInput, firstNameError, 'Имя должно содержать минимум 2 символа'); return false; }
      hideError(firstNameInput, firstNameError);
      return true;
    }

    function validateLastName() {
      const v = (lastNameInput.value || '').trim();
      if (!v) { showError(lastNameInput, lastNameError, 'Поле "Фамилия" обязательно для заполнения'); return false; }
      if (v.length < 2) { showError(lastNameInput, lastNameError, 'Фамилия должна содержать минимум 2 символа'); return false; }
      hideError(lastNameInput, lastNameError);
      return true;
    }

    function validatePhone() {
      // Для маски +{7} (...) unmaskedValue содержит цифры вместе с 7 (обычно 11)
      const digits = (phoneMask.unmaskedValue || '').replace(/\D/g,'');
      // Приводим к +7XXXXXXXXXX (10 цифр после 7)
      const isOk = /^7\d{10}$/.test(digits);
      if (!isOk) { showError(phoneInput, phoneError, 'Введите корректный номер телефона'); return false; }
      hideError(phoneInput, phoneError);
      return true;
    }

    function validateCheckboxes() {
      let ok = true;

      if (!agreement1.checked) { agreement1Error.textContent = 'Необходимо согласие с Офертой'; ok = false; }
      else agreement1Error.textContent = '';

      if (!agreement2.checked) { agreement2Error.textContent = 'Необходимо согласие с Политикой конфиденциальности'; ok = false; }
      else agreement2Error.textContent = '';

      if (!agreement3.checked) { agreement3Error.textContent = 'Необходимо согласие с Обработкой персональных данных'; ok = false; }
      else agreement3Error.textContent = '';

      return ok;
    }

    function buildPhoneE164() {
      const digits = (phoneMask.unmaskedValue || '').replace(/\D/g,''); // 7XXXXXXXXXX
      if (!/^7\d{10}$/.test(digits)) return null;
      return `+${digits}`; // +7XXXXXXXXXX
    }

    // ===== Real-time validation =====
    firstNameInput.addEventListener('blur', validateFirstName);
    lastNameInput.addEventListener('blur', validateLastName);
    phoneInput.addEventListener('blur', validatePhone);

    agreement1.addEventListener('change', () => { if (agreement1.checked) agreement1Error.textContent = ''; });
    agreement2.addEventListener('change', () => { if (agreement2.checked) agreement2Error.textContent = ''; });
    agreement3.addEventListener('change', () => { if (agreement3.checked) agreement3Error.textContent = ''; });

    // ===== Submit =====
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      hideFatal();

      // Валидация (одним проходом)
      const ok =
        (validateFirstName() ? 1 : 0) &
        (validateLastName()  ? 1 : 0) &
        (validatePhone()     ? 1 : 0) &
        (validateCheckboxes()? 1 : 0);

      if (!ok) return;

      const phoneE164 = buildPhoneE164();
      if (!phoneE164) {
        showError(phoneInput, phoneError, 'Введите корректный номер телефона');
        return;
      }

      // Telegram context (если открыто из Telegram)
      const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
      const initData = tg ? (tg.initData || '') : '';
      const initDataUnsafe = tg ? (tg.initDataUnsafe || null) : null;

      const payload = {
        firstName: (firstNameInput.value || '').trim(),
        lastName: (lastNameInput.value || '').trim(),
        phone: phoneE164,
        telegram: {
          initData,
          user: initDataUnsafe && initDataUnsafe.user ? initDataUnsafe.user : null
        }
      };

      submitBtn.disabled = true;
      loadingIndicator.classList.remove('hidden');

      try {
        const res = await fetch('/api/submit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        if (!res.ok) {
          const t = await res.text().catch(() => '');
          throw new Error(t || `HTTP ${res.status}`);
        }

        registrationForm.classList.add('hidden');
        successMessage.classList.add('show');

        if (tg) { try { tg.close(); } catch (_) {} }
      } catch (err) {
        showFatal(`Произошла ошибка при отправке данных: ${err && err.message ? err.message : 'неизвестная ошибка'}`);
      } finally {
        submitBtn.disabled = false;
        loadingIndicator.classList.add('hidden');
      }
    });

    // Smooth scroll
    document.querySelectorAll('a[href^="#"]').forEach(a => {
      a.addEventListener('click', (e) => {
        e.preventDefault();
        const target = document.querySelector(a.getAttribute('href'));
        if (target) target.scrollIntoView({ behavior: 'smooth', block: 'start' });
      });
    });

    // Telegram init
    if (window.Telegram && window.Telegram.WebApp) {
      const tg = window.Telegram.WebApp;
      tg.ready();
      tg.expand();

      if (tg.themeParams) {
        document.documentElement.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#ffffff');
        document.documentElement.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color || '#000000');
        document.documentElement.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color || '#3390ec');
        document.documentElement.style.setProperty('--tg-theme-button-text-color', tg.themeParams.button_text_color || '#ffffff');
      }
    }
  </script>
</body>
</html>
